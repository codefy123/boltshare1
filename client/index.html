<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoltShare - High Speed File Transfer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Radar Animation */
        @keyframes radar-ping {
            0% { transform: scale(0.1); opacity: 0; }
            50% { opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .radar-ring {
            animation: radar-ping 3s infinite linear;
        }
        .radar-ring:nth-child(2) { animation-delay: 1s; }
        .radar-ring:nth-child(3) { animation-delay: 2s; }
        
        body { background-color: #0f172a; color: #e2e8f0; } /* Slate 900 */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(51, 65, 85, 0.5); 
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans">

    <aside class="w-20 lg:w-64 glass-panel border-r-0 border-r border-slate-700 flex flex-col items-center lg:items-start py-8 z-20">
        <div class="px-6 mb-10 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <i data-lucide="zap" class="text-white w-6 h-6"></i>
            </div>
            <span class="hidden lg:block text-2xl font-bold tracking-tight text-white">BoltShare</span>
        </div>
        
        <nav class="w-full space-y-2 px-3">
            <div class="flex items-center gap-4 px-4 py-3 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-900/20 cursor-pointer">
                <i data-lucide="wifi"></i>
                <span class="hidden lg:block font-medium">Radar</span>
            </div>
            <div class="flex items-center gap-4 px-4 py-3 text-slate-400 hover:bg-slate-800 rounded-xl cursor-pointer transition">
                <i data-lucide="shield"></i>
                <span class="hidden lg:block font-medium">Secure</span>
            </div>
        </nav>

        <div class="mt-auto px-6 w-full hidden lg:block">
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <p class="text-xs font-medium text-slate-400 uppercase mb-2">My Device</p>
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-700 rounded-lg"><i data-lucide="smartphone" size="18"></i></div>
                    <div>
                        <p id="my-id-display" class="text-sm font-semibold text-white">Connecting...</p>
                        <p class="text-xs text-green-400">Online</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative flex flex-col p-6 lg:p-10">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 z-10">
            <div>
                <h1 class="text-3xl font-bold text-white">Discovery Radar</h1>
                <p class="text-slate-400 text-sm mt-1">Found devices on: <span id="room-name" class="text-blue-400 font-mono">Auto (WiFi)</span></p>
            </div>

            <div class="glass-panel p-1.5 rounded-xl flex items-center gap-2">
                <input id="room-code-input" type="text" placeholder="Enter Secret Code" class="bg-transparent px-3 py-2 outline-none text-sm w-40 text-white placeholder-slate-500">
                <button onclick="joinRoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Connect</button>
            </div>
        </header>

        <div class="flex-1 relative flex items-center justify-center border border-slate-800 rounded-3xl bg-slate-900/50 overflow-hidden">
            
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="radar-ring w-[300px] h-[300px] border border-blue-500/30 rounded-full absolute"></div>
                <div class="radar-ring w-[500px] h-[500px] border border-blue-500/20 rounded-full absolute"></div>
                <div class="radar-ring w-[700px] h-[700px] border border-slate-700/30 rounded-full absolute border-dashed"></div>
            </div>

            <div id="user-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 z-10 w-full max-w-5xl p-6">
                <div id="scanning-msg" class="col-span-full text-center text-slate-500 mt-10">
                    <p class="animate-pulse">Scanning for nearby devices...</p>
                    <p class="text-xs mt-2 opacity-50">Ensure both devices are on the same network or use the same code.</p>
                </div>
            </div>
        </div>

        <div id="progress-container" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-lg glass-panel p-5 rounded-2xl shadow-2xl z-50 border-t border-blue-500/50">
            <div class="flex justify-between items-center mb-3">
                <span id="status-text" class="text-sm font-medium text-blue-400">Sending file...</span>
                <span id="progress-percent" class="text-sm font-bold text-white">0%</span>
            </div>
            <div class="h-2.5 w-full bg-slate-700 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-200 w-0"></div>
            </div>
        </div>

        <input type="file" id="file-input" class="hidden">
    </main>

    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: CHANGE THIS TO YOUR RENDER BACKEND URL AFTER DEPLOYING SERVER
        // Example: 'https://boltshare-server.onrender.com'
        const SOCKET_URL = 'https://boltshare-server.onrender.com'; 
        
        const socket = io(SOCKET_URL);
        
        // --- VARIABLES ---
        let myId = '';
        let peers = {};       // WebRTC Connections
        let dataChannels = {}; // Data Channels
        let connectedUsers = [];
        let selectedPeerId = null;

        // UI Elements
        const myIdDisplay = document.getElementById('my-id-display');
        const userGrid = document.getElementById('user-grid');
        const scanningMsg = document.getElementById('scanning-msg');
        const fileInput = document.getElementById('file-input');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const statusText = document.getElementById('status-text');
        const roomNameDisplay = document.getElementById('room-name');
        const roomCodeInput = document.getElementById('room-code-input');

        // WebRTC Config (Google STUN)
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // --- SOCKET.IO EVENTS ---

        socket.on('connect', () => console.log("Connected to Signal Server"));

        socket.on('my-info', (data) => {
            myId = data.id;
            myIdDisplay.innerText = `User ${myId.substr(0, 4)}`;
        });

        socket.on('user-found', (user) => {
            if (!connectedUsers.find(u => u.id === user.id)) {
                connectedUsers.push(user);
                renderUsers();
            }
        });

        socket.on('joined-room', (roomCode) => {
            roomNameDisplay.innerText = roomCode;
            connectedUsers = []; // Clear users from old room
            renderUsers();
        });

        socket.on('user-disconnected', (id) => {
            connectedUsers = connectedUsers.filter(u => u.id !== id);
            if (peers[id]) peers[id].close();
            delete peers[id];
            delete dataChannels[id];
            renderUsers();
        });

        socket.on('signal', async (data) => {
            const { sender, signal } = data;
            
            if (!peers[sender]) await createPeerConnection(sender, false);
            const peer = peers[sender];

            if (signal.type === 'offer') {
                await peer.setRemoteDescription(new RTCSessionDescription(signal));
                const answer = await peer.createAnswer();
                await peer.setLocalDescription(answer);
                socket.emit('signal', { target: sender, signal: peer.localDescription });
            } else if (signal.type === 'answer') {
                await peer.setRemoteDescription(new RTCSessionDescription(signal));
            } else if (signal.candidate) {
                await peer.addIceCandidate(new RTCIceCandidate(signal.candidate));
            }
        });

        // --- CORE WEBRTC LOGIC ---

        async function createPeerConnection(targetId, isInitiator) {
            const peer = new RTCPeerConnection(rtcConfig);
            peers[targetId] = peer;

            peer.onicecandidate = (e) => {
                if (e.candidate) {
                    socket.emit('signal', { target: targetId, signal: { candidate: e.candidate } });
                }
            };

            peer.onconnectionstatechange = () => {
                if (peer.connectionState === 'connected') {
                    updateUserCardStatus(targetId, true);
                }
            };

            if (isInitiator) {
                const channel = peer.createDataChannel("file-transfer");
                setupDataChannel(channel, targetId);
                dataChannels[targetId] = channel;
                
                const offer = await peer.createOffer();
                await peer.setLocalDescription(offer);
                socket.emit('signal', { target: targetId, signal: peer.localDescription });
            } else {
                peer.ondatachannel = (e) => {
                    setupDataChannel(e.channel, targetId);
                    dataChannels[targetId] = e.channel;
                };
            }
        }

        function setupDataChannel(channel, targetId) {
            channel.onopen = () => console.log(`Channel Open with ${targetId}`);
            channel.onmessage = (e) => handleDataReceived(e.data);
        }

        // --- FILE TRANSFER ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && selectedPeerId && dataChannels[selectedPeerId]) {
                sendFile(file, dataChannels[selectedPeerId]);
            }
            fileInput.value = ''; 
        });

        function sendFile(file, channel) {
            const CHUNK_SIZE = 16 * 1024; // 16KB
            
            // 1. Send Meta
            channel.send(JSON.stringify({
                type: 'metadata', name: file.name, size: file.size, mime: file.type
            }));

            progressContainer.classList.remove('hidden');
            statusText.innerText = `Sending ${file.name}...`;

            // 2. Send Chunks
            let offset = 0;
            const reader = new FileReader();

            reader.onload = (e) => {
                const buffer = e.target.result;
                
                // Backpressure Check
                if (channel.bufferedAmount > 16 * 1024 * 1024) { 
                    setTimeout(() => reader.onload(e), 50);
                    return;
                }

                channel.send(buffer);
                offset += buffer.byteLength;
                
                // Progress
                const percent = Math.round((offset / file.size) * 100);
                progressBar.style.width = `${percent}%`;
                progressPercent.innerText = `${percent}%`;

                if (offset < file.size) {
                    readNextChunk();
                } else {
                    statusText.innerText = "Sent Successfully!";
                    setTimeout(() => progressContainer.classList.add('hidden'), 3000);
                }
            };

            const readNextChunk = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            readNextChunk();
        }

        // --- FILE RECEIVING ---

        let receivedChunks = [];
        let receivedSize = 0;
        let fileMeta = null;

        function handleDataReceived(data) {
            if (typeof data === 'string') {
                const parsed = JSON.parse(data);
                if (parsed.type === 'metadata') {
                    fileMeta = parsed;
                    receivedChunks = [];
                    receivedSize = 0;
                    progressContainer.classList.remove('hidden');
                    statusText.innerText = `Receiving ${fileMeta.name}...`;
                }
                return;
            }

            receivedChunks.push(data);
            receivedSize += data.byteLength;

            if (fileMeta) {
                const percent = Math.round((receivedSize / fileMeta.size) * 100);
                progressBar.style.width = `${percent}%`;
                progressPercent.innerText = `${percent}%`;

                if (receivedSize === fileMeta.size) {
                    statusText.innerText = "Download Complete!";
                    const blob = new Blob(receivedChunks, { type: fileMeta.mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileMeta.name;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    receivedChunks = [];
                    fileMeta = null;
                    setTimeout(() => progressContainer.classList.add('hidden'), 3000);
                }
            }
        }

        // --- UI HELPERS ---

        function joinRoom() {
            const code = roomCodeInput.value.trim();
            if (code) socket.emit('join-room', code);
        }

        function handleConnectClick(targetId) {
            const btn = document.getElementById(`btn-${targetId}`);
            if (btn.innerText === "Connect") {
                btn.innerText = "Connecting...";
                createPeerConnection(targetId, true);
            } else {
                selectedPeerId = targetId;
                fileInput.click();
            }
        }

        function updateUserCardStatus(userId, isConnected) {
            const indicator = document.getElementById(`status-${userId}`);
            const btn = document.getElementById(`btn-${userId}`);
            
            if (isConnected) {
                indicator.className = `w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]`;
                btn.className = "w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition text-sm text-white flex justify-center items-center gap-2";
                btn.innerHTML = `<i data-lucide="send" size="16"></i> Send File`;
                lucide.createIcons();
            }
        }

        function renderUsers() {
            scanningMsg.style.display = connectedUsers.length === 0 ? 'block' : 'none';
            document.querySelectorAll('.user-card').forEach(c => c.remove());

            connectedUsers.forEach(user => {
                const card = document.createElement('div');
                card.className = "user-card bg-slate-800/80 backdrop-blur border border-slate-700 p-6 rounded-2xl hover:border-blue-500/50 transition relative overflow-hidden group";
                card.id = `card-${user.id}`;
                card.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-lg text-white">
                            ${user.name.charAt(user.name.length - 1)}
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-white">${user.name}</h3>
                            <div class="flex items-center gap-2">
                                <span id="status-${user.id}" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                <p class="text-xs text-slate-400">Ready</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="handleConnectClick('${user.id}')" id="btn-${user.id}" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition text-sm text-white">
                        Connect
                    </button>
                `;
                userGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>
